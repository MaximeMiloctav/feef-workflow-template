<template>
  <UDashboardGroup>
    <UDashboardSidebar collapsible resizable :ui="{ footer: 'lg:border-t lg:border-default' }">
      <template #header="{ collapsed }">
        <div class="w-full flex justify-center items-center pt-2">
          <NuxtLink to="/">
            <img v-if="!collapsed" class="max-w-[70px] h-auto cursor-pointer mx-auto"
              alt="PME+ Engagé"
              src="~/assets/images/Logo-PMEplus.png">
            <img v-else class="h-8 w-8 cursor-pointer object-contain mx-auto" alt="PME+"
              src="~/assets/images/Logo-PMEplus.png">
          </NuxtLink>
        </div>
      </template>

      <template #default="{ collapsed }">
  <SwitchCompanyMenu :collapsed="collapsed" @update:id="selectedCompanyId = $event" />

        <UNavigationMenu
          :collapsed="collapsed"
          :items="items.slice(0,4)"
          orientation="vertical"
        />
        <USeparator label="Entreprises du groupe" class="my-3" />
        <UNavigationMenu
          :collapsed="collapsed"
          :items="items.slice(5)"
          orientation="vertical"
        />
      </template>

      <template #footer="{ collapsed }">
        <UserMenu :collapsed="collapsed" />
      </template>
    </UDashboardSidebar>
    
    <UDashboardPanel>
      <template #header>
        <UDashboardNavbar>
          <template #right>
            <UButton
              icon="i-lucide-repeat"
              label="Changer d'organisme évaluateur"
              color="primary"
              variant="outline"
            />
          </template>
        </UDashboardNavbar>
      </template>
      <slot />
    </UDashboardPanel>
    <NotificationsSlideover />
  </UDashboardGroup>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { COMPANIES, getCompanyById } from '../components/../utils/data'

const selectedCompanyId = ref(COMPANIES.length > 0 ? COMPANIES[0].id : '')

const selectedCompany = computed(() => getCompanyById(selectedCompanyId.value))

const items = computed(() => {
  const baseItems = [
    { label: 'Mon dossier', icon: 'i-lucide-home', to: `/company/${selectedCompanyId.value}` },
    { label: 'Mon espace documentaire', icon: 'i-lucide-folder-open', to: `/company/documents` },
    { label: 'Mes contrats', icon: 'i-lucide-file-signature', to: `/company/contracts` },
    { label: 'Mes audits', icon: 'i-lucide-clipboard-list', to: `/company/labeling-cases` }
  ]

  const company = selectedCompany.value

  // Si l'entreprise est un groupe, afficher les entreprises du groupe
  if (company?.appartenanceGroupe?.estGroupe && company.appartenanceGroupe.entreprisesGroupe?.length) {
    const groupCompanies = company.appartenanceGroupe.entreprisesGroupe.map(entrepriseId => {
      const entreprise = getCompanyById(entrepriseId)
      return {
        label: entreprise?.raisonSociale.nom || entrepriseId,
        icon: 'i-lucide-building-2',
        to: `/company/${entrepriseId}`
      }
    })
    return [...baseItems, { type: 'label' as const, label: '' }, ...groupCompanies]
  }

  return baseItems
})
</script>
